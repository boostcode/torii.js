<% layout('layout') -%>

<table id="example1" class="table table-bordered table-striped" width="100%">
	<thead>
		<tr>
			<th>Username</th>
			<th>Name</th>
			<th>Surname</th>
			<th>Role</th>
			<th>Actions</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
	</tbody>
	<tfoot>
		<tr>
			<th>Username</th>
			<th>Name</th>
			<th>Surname</th>
			<th>Role</th>
			<th>Actions</th>
		</tr>
	</tfoot>
</table>

<!-- data tables -->
<script src="/js/plugins/datatables/jquery.dataTables.js" type="text/javascript"></script>
<script src="/js/plugins/datatables/dataTables.bootstrap.js" type="text/javascript"></script>

<!-- torii structure -->
<script type="text/javascript">

$( document ).ready(function() {
	
	// check session
	if(!$.cookie('toriijs')){
		location.href = '/auth/login';
	}
	
	// populate table
	var table = $('#example1').DataTable({
		
		//bServerSide: true,
		bProcessing: true,
		bDeferRender: true,
		bSort: false,
        sAjaxSource: "/user/list.json",
		ajax: {
			url: "/user/list.json",
			type: "POST"
		},
		fnServerData: function (sSource, aoData, fnCallback) {
			
			aoData.push( { 
				name: 'username',
				value: splits[0] 
			});
			
			aoData.push( { 
				name: 'token',
				value: splits[1] 
			});
						
			$.ajax({
				dataType: 'json',
                type: "POST",
				url: sSource,
				data: aoData,
				success: fnCallback
			});
		},
		aoColumns: [
			{ 
				mData: "username",
				mRender: function(data, type, item) { 
					return item.username; 
				}
			},
			{ 
				mData: "name",
				mRender: function(data, type, item) { 
					return item.name; 
				}
			},
			{ 
				mData: "surname",
				mRender: function(data, type, item) { 
					return item.surname; 
				}
			},
			{ 
				mData: "roles",
				mRender: function(data, type, item) {
					if(item.roles){
						return item.roles[0]; 
					} else {
						return 'None';
					}
				}
			},
			
			{ 
				mData: "_id",
				mRender: function(data, type, item) { 
					return '<a href="/admin/user/'+item._id+'/edit" class="btn btn-primary">Edit</a> <a href="#" class="btn btn-danger" data-codice="'+item._id+'">Remove</a>'; 
				}
			}
		],
		fnDrawCallback : function ( oSettings ) {
			
			// remove user
			$(".btn-danger").click(function(){
			
				var txt;
				var r = confirm("Warning , do you confirm to remove user? This operation is irreversible!");
				
				if (r == true) {
					
					var id = $(this).data("codice");

					// TODO: only admin user can remove
					
					// you can't remove yourself
					if(splits[2] == id){
						alert('Sorry you can\'t remove yourself!');
						return;
					}
					
					$.ajax({
						type: "POST",
						url: '/user/remove',
						data: {
							userid: id,
							username: splits[0],
							token: splits[1]
						},
						success: function (data, status){
              location.reload();
						},
						error: function (req, status, error){
							$('#errordiv').show();
							$('#error').html('<i class="fa fa-times-circle-o"></i> '+error);
						}
					});
					
				
				} else {}
			
			
			}); 
			
		}
	}); 

});
</script>
