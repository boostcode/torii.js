<% layout('layout') -%>

<!--div class="col-md-12" style="text-align:center;">
	<a href="#" id="removeAll" class="btn btn-primary">Remove All</a>
</div>

<div class="col-md-12" style="text-align:center;">
	<a href="#" id="checkUpdate" class="btn btn-primary">Check Update</a>
</div-->

<table id="tbCollection" class="table table-bordered table-striped">
	<thead id="table_head">
		
	</thead>
	<tbody id="table_body">
		
	</tbody>
	<tfoot id="table_foot">
		
	</tfoot>
</table>


<!-- DATA TABES SCRIPT -->
<script src="/js/plugins/datatables/jquery.dataTables.js" type="text/javascript"></script>
<script src="/js/plugins/datatables/dataTables.bootstrap.js" type="text/javascript"></script>


<!-- Struttura app -->
<script type="text/javascript">

$( document ).ready(function() {

	// check session
	if(!$.cookie('toriijs')){
		location.href = '/auth/login';
	}
	
	var table;
	
	var nome_collezione = '<%= req.params.collection_name %>';
	
	userAndToken["query"] = {"nome_collezione" : nome_collezione}; 
		
	// retrieve collections for menu
	$.ajax({
		type: "POST",
		url: "/collection/torii_structure/documents.json",
		data: userAndToken,
		success: function(data, status) {
			
			if(status == 'success') {
				
				//console.log(data);
				
				if(!data.aaData[0])
					location.href = '/admin';
				
				
				var campi = data.aaData[0]["struttura"];
				
				var html_head = '<tr>';
				var html_body = '<tr>';
				
				var lab = [];
				
				campi.forEach(function(campo) { 
				
					html_head += '<th>'+ campo["label"] +'</th>' ;
					html_body += '<td></td>';
					
					lab.push({mData : campo["field_name"]});
					
				})
				
				lab.push({ mData: "_id", mRender: function(data, type, item) { return '<a href="/admin/'+ nome_collezione +'/'+item._id+'/edit" class="btn btn-primary">Edit</a> <a href="#" class="btn btn-danger" data-codice="'+item._id+'">Delete</a>'; }});
				
				html_head += '<th>Actions</th></tr>';
				html_body += '<td></td></tr>';
				
				$('#table_head').html(html_head);
				$('#table_body').html(html_body);
				$('#table_foot').html(html_head);
				
				// preparo la tabella
				table = $('#tbCollection').DataTable({
				
            bServerSide: true,
					bProcessing: true,
					bDeferRender: true,
					bSort: false,
                    sAjaxSource: "/collection/"+ nome_collezione +"/documents.json",
					ajax: {
						url: "/collection/"+ nome_collezione +"/documents.json",
						type: "POST"
					},
					fnServerData: function (sSource, aoData, fnCallback) {
						
						aoData.push( { 
							name: 'username',
							value: splits[0] 
						});
						
						aoData.push( { 
							name: 'token',
							value: splits[1] 
						});
									
						$.ajax({
							dataType: 'json',
                            type: "POST",
							url: sSource,
							data: aoData,
							success: fnCallback
						});
						
					},
					aoColumns: lab,
					fnDrawCallback : function ( oSettings ) {
						
						// Rimuovo il documento
						$(".btn-danger").click(function(){
						
							var r = confirm("Attenzione , desideri cancellare il documento ? Questa azione è irreversibile");
							
							if (r == true) {
				  
								// Recupero il nome del documento
								var id_doc = $(this).data("codice");
						
								$.post('/collection/'+ nome_collezione +'/'+ id_doc +'/delete', userAndToken, function(res) {
					 		
									table.ajax.reload();
					 		
								});
							
							} else {}
						
							// TODO: only admin user can remove
							
							// TODO: i can't remove myself
						
						}); 
					
					}
				
				}); 
				
			}
		},
		error: function(req, status, error){
			$('#errordiv').show();
			$('#error').html('<i class="fa fa-times-circle-o"></i> '+error);
		}
	});

	$('#removeAll').on('click', function(){
		
		var r = confirm("Attenzione , desideri cancellare tutti i documenti ? Questa azione è irreversibile");
							
							if (r == true) {
				  
								// Recupero il nome del documento
								var id_doc = $(this).data("codice");
						
								$.post('/collection/'+ nome_collezione +'/delete_all', userAndToken, function(res) {
					 		
									table.ajax.reload();
					 		
								});
							
							} else {}
		
	});


	$('#checkUpdate').on('click', function() {
				
		userAndToken["last_update"] = new Date().getTime(); 
						
		$.post('/collection/'+ nome_collezione +'/hasupdate', userAndToken, function(res) {
					 		
			alert(JSON.stringify(res));
					 		
		});

		
	});

});
</script>
